<!DOCTYPE html>
<html>
<head>
    <title>WebChat Pro 2.0</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; display: flex; height: 100vh; background: #e5ddd5; }
        #auth { position: fixed; inset: 0; background: #f0f2f5; display: flex; align-items: center; justify-content: center; z-index: 10; }
        .card { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); text-align: center; }
        input { display: block; width: 250px; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; }
        button { background: #00a884; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 5px; width: 100%; font-weight: bold; }
        #app { display: none; width: 100%; display: flex; }
        #sidebar { width: 300px; background: white; border-right: 1px solid #ddd; }
        #chat { flex: 1; display: flex; flex-direction: column; position: relative; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px; border-radius: 10px; max-width: 70%; }
        .sent { align-self: flex-end; background: #dcf8c6; }
        .received { align-self: flex-start; background: white; }
        #video-overlay { display: none; position: absolute; inset: 0; background: black; z-index: 5; }
        video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { width: 120px; height: 150px; position: absolute; bottom: 20px; right: 20px; border: 2px solid white; }
    </style>
</head>
<body>

<div id="auth">
    <div class="card">
        <h2 id="t">Login</h2>
        <input id="u" placeholder="Username">
        <input id="p" type="password" placeholder="Password">
        <button onclick="auth('login')" id="btn">Login</button>
        <p onclick="toggle()" style="color:blue; cursor:pointer; font-size:12px; margin-top:10px;">Switch to Sign Up</p>
    </div>
</div>

<div id="app" style="display:none;">
    <div id="sidebar"><h3 style="padding:15px; background:#ededed; margin:0;">Contacts</h3><div id="ulist"></div></div>
    <div id="chat">
        <div style="background:#ededed; padding:15px; font-weight:bold; display:flex; justify-content:space-between;">
            <span id="cw">Select a Friend</span>
            <div id="c-ops" style="display:none;">
                <button onclick="call(true)" style="width:auto; background:none; color:black;">üéôÔ∏è</button>
                <button onclick="call(false)" style="width:auto; background:none; color:black;">üìû</button>
            </div>
        </div>
        <div id="messages"></div>
        <div id="video-overlay">
            <video id="rv" autoplay></video>
            <video id="lv" autoplay muted></video>
            <button onclick="location.reload()" style="position:absolute; bottom:20px; left:45%; background:red; width:auto;">End</button>
        </div>
        <div style="padding:10px; background:#f0f0f0; display:flex;">
            <input id="mi" style="flex:1; margin:0;" placeholder="Type message...">
            <button onclick="send()" style="width:auto; margin-left:10px;">Send</button>
        </div>
    </div>
</div>

<script>
    const socket = io('https://imperialtxt.onrender.com');
    const peer = new Peer();
    let me = "", target = { id: '', name: '' }, myStream, mode = 'login';

    navigator.mediaDevices.getUserMedia({video:true, audio:true}).then(s => { 
        myStream = s; document.getElementById('lv').srcObject = s; 
    });

    function toggle() {
        mode = mode === 'login' ? 'signup' : 'login';
        document.getElementById('t').innerText = mode === 'login' ? 'Login' : 'Sign Up';
        document.getElementById('btn').innerText = mode === 'login' ? 'Login' : 'Sign Up';
    }

    function auth(type) {
        socket.emit(mode, { username: u.value, password: p.value });
    }

    socket.on('auth-result', r => {
        if(r.success) {
            me = r.user;
            document.getElementById('auth').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
        } else alert(r.msg);
    });

    socket.on('update-users', users => {
        ulist.innerHTML = "";
        for(let id in users) {
            if(users[id] !== me) {
                let d = document.createElement('div');
                d.innerHTML = `<div style="padding:15px; border-bottom:1px solid #eee; cursor:pointer;">${users[id]}</div>`;
                d.onclick = () => {
                    target = { id: id, name: users[id] };
                    cw.innerText = target.name;
                    messages.innerHTML = "";
                    document.getElementById('c-ops').style.display = 'block';
                    socket.emit('get-history', { me: me, with: target.name });
                };
                ulist.appendChild(d);
            }
        }
    });

    socket.on('load-history', h => {
        h.forEach(m => addMsg(m.message, m.from === me ? 'sent' : 'received'));
    });

    function send() {
        if(!mi.value || !target.name) return;
        socket.emit('send-msg', { from: me, toName: target.name, toId: target.id, msg: mi.value });
        addMsg(mi.value, 'sent');
        mi.value = "";
    }

    socket.on('msg-receive', d => { if(d.from === target.name) addMsg(d.msg, 'received'); });

    function addMsg(t, c) {
        let d = document.createElement('div');
        d.className = 'msg ' + c;
        d.innerText = t;
        messages.appendChild(d);
        messages.scrollTop = messages.scrollHeight;
    }

    // Call Logic
    function call(isAudio) {
        document.getElementById('video-overlay').style.display = 'block';
        socket.emit('call-request', { toId: target.id, myPeer: peer.id, fromName: me, isAudio: isAudio });
    }

    socket.on('incoming-call', d => {
        if(confirm(`Incoming ${d.isAudio ? 'Audio' : 'Video'} call from ${d.fromName}?`)) {
            document.getElementById('video-overlay').style.display = 'block';
            const call = peer.call(d.fromPeer, myStream);
            call.on('stream', s => rv.srcObject = s);
        }
    });

    peer.on('call', c => {
        document.getElementById('video-overlay').style.display = 'block';
        c.answer(myStream);
        c.on('stream', s => rv.srcObject = s);
    });

    mi.onkeypress = e => { if(e.key === 'Enter') send(); };
</script>
</body>
</html>
